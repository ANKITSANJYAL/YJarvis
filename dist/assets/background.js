const E="OPENAI_API_KEY_ENC",A="OPENAI_API_KEY_IV";async function D(){const t=await crypto.subtle.importKey("raw",new TextEncoder().encode("jarvis-yt-assistant-fixed-salt"),{name:"PBKDF2"},!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:new TextEncoder().encode("jarvis-salt"),iterations:1e5,hash:"SHA-256"},t,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async function $(t){const n=await D(),e=crypto.getRandomValues(new Uint8Array(12));return{cipher:await crypto.subtle.encrypt({name:"AES-GCM",iv:e},n,new TextEncoder().encode(t)),iv:e}}async function N(t,n){const e=await D(),r=await crypto.subtle.decrypt({name:"AES-GCM",iv:n.buffer},e,t);return new TextDecoder().decode(r)}const S={async setKey(t){const{cipher:n,iv:e}=await $(t);await chrome.storage.local.set({[E]:Array.from(new Uint8Array(n)),[A]:Array.from(e)})},async getKey(){const t=await chrome.storage.local.get([E,A]),n=t[E],e=t[A];if(!n||!e)return null;const r=new Uint8Array(n).buffer,a=new Uint8Array(e);try{return await N(r,a)}catch{return null}},async clearKey(){await chrome.storage.local.remove([E,A])}};let T=0;const M=60;let I=Date.now();const f={canConsume(t=1){const n=Date.now();return n-I>6e4&&(I=n,T=0),T+t<=M},consume(t=1){if(!this.canConsume(t))throw new Error("Quota exceeded");T+=t},getStatus(){const t=Date.now(),n=Math.max(0,6e4-(t-I));return{used:T,limit:M,resetInMs:n}}},Y="You are Jarvis: witty, sophisticated, brief (1-2 sentences), professional but personable. Keep responses concise and helpful.",K={async prompt(t,n={}){var i,p,w,g;if(!f.canConsume(1))throw new Error("Rate limit exceeded");const e=await S.getKey();if(!e)throw new Error("Missing OpenAI API key");const r=n.system??Y,a=n.temperature??.6;f.consume(1);const c=async()=>fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({model:"gpt-4o-mini",messages:[{role:"system",content:r},{role:"user",content:t}],temperature:a})});let s=null;for(let h=0;h<3;h++){try{if(s=await c(),s.ok)break}catch{}await new Promise(y=>setTimeout(y,500*(h+1)))}if(!s||!s.ok){const y=[...(await chrome.storage.local.get(["AI_QUEUE"])).AI_QUEUE??[],t].slice(-50);await chrome.storage.local.set({AI_QUEUE:y});const b=s?await s.text():"offline/failed";throw new Error(`OpenAI error: ${b}`)}return((g=(w=(p=(i=(await s.json()).choices)==null?void 0:i[0])==null?void 0:p.message)==null?void 0:w.content)==null?void 0:g.trim())??""}},j="jarvis-cache",m="kv",O=1;function U(){return new Promise((t,n)=>{const e=indexedDB.open(j,O);e.onupgradeneeded=()=>{const r=e.result;r.objectStoreNames.contains(m)||r.createObjectStore(m)},e.onsuccess=()=>t(e.result),e.onerror=()=>n(e.error)})}const _={async get(t){const n=await U();return new Promise((e,r)=>{const c=n.transaction(m,"readonly").objectStore(m),s=c.get(t);s.onsuccess=()=>{const u=s.result;if(!u)return e(null);if(Date.now()>u.expiresAt){const o=c.delete(t);o.onsuccess=()=>e(null),o.onerror=()=>e(null);return}e(u.value)},s.onerror=()=>r(s.error)})},async set(t,n,e){const r=await U();return new Promise((a,c)=>{const u=r.transaction(m,"readwrite").objectStore(m),o={value:n,expiresAt:Date.now()+e},i=u.put(o,t);i.onsuccess=()=>a(),i.onerror=()=>c(i.error)})}};function C(t,n){const e=1/(1+(Date.now()-Date.parse(t.publishedAt))/31536e6),r=Math.log10(1+t.likeCount),c=.5*Math.log10(1+t.viewCount)+.4*r+.1*e;return n==="learn"?c+.2*e:c}const B={async searchBest(t){const n="YT_LAST_CALL",e=await G(n),r=Date.now();if(e&&r-e<500)return null;await L(n,r);const a=`yt:q:${t}`,c=await _.get(a);if(c)return c;if(!f.canConsume(1))throw new Error("Rate limit exceeded");const s=new URL("https://www.googleapis.com/youtube/v3/search");s.searchParams.set("q",t),s.searchParams.set("part","snippet"),s.searchParams.set("type","video"),s.searchParams.set("maxResults","5");const u=await fetch(s.toString());if(!u.ok)throw new Error(`YouTube API error ${u.status}`);const o=await u.json(),i=o.items.map(l=>l.id.videoId).join(","),p=new URL("https://www.googleapis.com/youtube/v3/videos");p.searchParams.set("id",i),p.searchParams.set("part","statistics,snippet");const w=await fetch(p.toString());if(!w.ok)throw new Error(`YouTube API error ${w.status}`);const g=await w.json();f.consume(1);const y=o.items.map(l=>{const d=g.items.find(R=>R.id===l.id.videoId);return{videoId:l.id.videoId,title:l.snippet.title,channelTitle:l.snippet.channelTitle,publishedAt:l.snippet.publishedAt,description:(d==null?void 0:d.snippet.description)??l.snippet.description,viewCount:d?Number(d.statistics.viewCount):0,likeCount:d?Number(d.statistics.likeCount):0}}).filter(l=>!/(shocking|you won't believe|click here|gone wrong)/i.test(l.title)),b=/(tutorial|how to|guide|course|lesson|learn)/i.test(t)?"learn":"entertain",x=y.sort((l,d)=>C(d,b)-C(l,b))[0]??null;return x&&await _.set(a,x,60*60*1e3),x}};async function G(t){try{return await _.get(`ts:${t}`)??null}catch{return null}}async function L(t,n){await _.set(`ts:${t}`,n,60*60*1e3)}async function q(t,n){const e=new URL("https://www.youtube.com/api/timedtext");e.searchParams.set("v",t),e.searchParams.set("lang",n);const r=await fetch(e.toString());if(!r.ok)return null;const a=await r.text(),c=new DOMParser().parseFromString(a,"text/xml"),s=Array.from(c.getElementsByTagName("text"));if(!s.length)return null;const u=o=>o.replace(/&#39;/g,"'").replace(/&quot;/g,'"').replace(/&amp;/g,"&");return s.map(o=>({start:Number(o.getAttribute("start")??0),dur:Number(o.getAttribute("dur")??0),text:u(o.textContent??"")}))}const P={async getTranscript(t){const n=["en","en-US","en-GB"];for(const e of n)try{const r=await q(t,e);if(r&&r.length)return r}catch{}return null}};async function Q(t,n){const e=t.slice(0,400).map(c=>`[${Math.round(c.start)}s] ${c.text}`).join(`
`),a=`${n==="brief"?"In 2-3 sentences, summarize concisely with 2-3 key points.":n==="standard"?"Provide a short paragraph summary with key concepts.":"Provide bullet-point detailed summary with timestamp-linked highlights."}

Transcript excerpt:
${e}`;return K.prompt(a,{temperature:.4})}function v(){return crypto.randomUUID()}function F(t,n){var u;const e=n<600?5:n<1800?10:15,r=t.split(/\.|\n/).map(o=>o.trim()).filter(Boolean),c=(o=>r.slice(0,Math.min(o,r.length)))(e*2),s=[];for(let o=0;o<e;o++){const i=c[o%c.length]??"General concept";if(o%3===0){const p=i,w=[i.replace(/\b(\w+)\b/,"$1 concept"),i.replace(/\b(\w+)\b/,"$1 method"),"None of the above"];s.push({id:v(),type:"mcq",prompt:`Which best describes: ${i}?`,options:V([p,...w]).slice(0,4),answer:p,difficulty:k(o)})}else if(o%3===1){const p=i.length>10?i:`${i} is discussed.`;s.push({id:v(),type:"truefalse",prompt:p,answer:!0,difficulty:k(o)})}else s.push({id:v(),type:"short",prompt:`Explain briefly: ${i}`,answer:i,difficulty:k(o)})}if(r.length){const o=r[0]??"",i=((u=o.match(/\b(\w{5,})\b/))==null?void 0:u[1])??"concept";s.push({id:v(),type:"fill",prompt:o.replace(i,"_____"),answer:i,difficulty:"medium"})}return s}function V(t){return[...t].sort(()=>Math.random()-.5)}function k(t){return t%5===0?"hard":t%2===0?"medium":"easy"}const z={async handle(t,n){switch(t.type){case"GET_API_KEY":return S.getKey();case"SET_API_KEY":return S.setKey(t.payload.key).then(()=>({ok:!0}));case"CLEAR_API_KEY":return S.clearKey().then(()=>({ok:!0}));case"GET_QUOTA":return f.getStatus();case"AI_PROMPT":return K.prompt(t.payload.text);case"YT_SEARCH_BEST":return B.searchBest(t.payload.query);case"YT_GET_TRANSCRIPT":return P.getTranscript(t.payload.videoId);case"YT_SUMMARIZE":{const e=await P.getTranscript(t.payload.videoId);return e?Q(e,t.payload.level):null}case"QUIZ_GENERATE":{const e=await P.getTranscript(t.payload.videoId);if(!e)return null;const r=e.map(s=>s.text).join(`
`),a=e[e.length-1],c=Math.round(((a==null?void 0:a.start)??0)+((a==null?void 0:a.dur)??0));return F(r,c)}case"QUIZ_GRADE":return await K.prompt(`Grade the answer with brief feedback. Return JSON with {score: 0..1, feedback}.
Question: ${t.payload.prompt}
Answer: ${t.payload.answer}`,{temperature:.2});default:return{error:"Unknown message type"}}}};chrome.runtime.onMessage.addListener((t,n,e)=>(z.handle(t,n).then(e).catch(r=>e({error:String(r)})),!0));self.addEventListener("install",()=>{});self.addEventListener("activate",()=>{});
